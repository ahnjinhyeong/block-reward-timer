<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>30ë¶„ ë¸”ëŸ­ ë³´ìƒ ì„ íƒê¸° (ë¼ì´íŠ¸) â€” FIX v4 + BlockTower + Quotes</title>

  <!-- PWA & ëª¨ë°”ì¼ ì•± ì„¤ì • -->
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0b0f14">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f9fc">

  <!-- PWA manifest (ì •ì ) -->
  <link rel="manifest" href="./manifest.webmanifest">

  <!-- iOS í™ˆí™”ë©´ ì§€ì› -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="ë¸”ëŸ­ë³´ìƒ">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <!-- íŒŒë¹„ì½˜(PC ë¸Œë¼ìš°ì € íƒ­ ì•„ì´ì½˜) -->
  <link rel="icon" href="./icon-192.png" sizes="192x192" type="image/png">
  <link rel="icon" href="./icon-512.png" sizes="512x512" type="image/png">

  <style>
    :root{ --bg:#0b0f14; --panel:#121821; --muted:#8aa0b2; --text:#e6edf3; --acc:#6ea8fe; --ok:#36d399; --warn:#fbbc04; --danger:#ef4444; }
    [data-theme="light"]{ --bg:#f7f9fc; --panel:#ffffff; --muted:#4b5563; --text:#0b0f14; --acc:#2f6aea; --ok:#16a34a; --warn:#c08a00; --danger:#b91c1c; }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--text);}    
    .wrap{max-width:880px; margin:20px auto; padding:16px}
    .card{background:var(--panel); border:1px solid #1f2937; border-radius:16px; padding:16px; box-shadow:0 6px 20px rgba(0,0,0,.25)}
    h1{font-size:22px; margin:0 0 6px}
    h2{font-size:16px; margin:18px 0 8px; color:#cbd5e1}
    [data-theme="light"] h2{ color:#0f172a }
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .timer{font-variant-numeric:tabular-nums; font-size:56px; font-weight:700; letter-spacing:1px}
    .pill{border:1px solid #223042; padding:8px 10px; border-radius:999px; cursor:pointer; user-select:none; color:#cfe1f2}
    [data-theme="light"] .pill{border-color:#cbd5e1; color:#0b0f14}
    .pill.active{background:var(--acc); color:#081018; border-color:var(--acc)}
    .btn{border:1px solid #223042; background:#0f1520; color:#cfe1f2; padding:10px 14px; border-radius:10px; cursor:pointer}
    [data-theme="light"] .btn{ background:#f1f5f9; color:#0b0f14; border-color:#cbd5e1 }
    .btn.primary{background:var(--acc); color:#07121f; border:0}
    .btn.ok{background:var(--ok); color:#062013; border:0}
    .btn.warn{background:var(--warn); color:#1d1302; border:0}
    .btn.ghost{background:transparent}
    .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:10px}
    .reward{border:1px solid #223042; background:#0e141e; border-radius:12px; padding:10px; cursor:pointer; text-align:left; color:#ffffff;}
    .reward:hover{border-color:#2f4058}
    [data-theme="light"] .reward{ background:#f8fafc; border-color:#e2e8f0; color:#0b0f14; }
    [data-theme="light"] .reward:hover{ border-color:#94a3b8 }
    .muted{color:var(--muted)}
    .log{max-height:220px; overflow:auto; border:1px dashed #223042; border-radius:12px; padding:8px}
    .kpis{display:flex; gap:12px; flex-wrap:wrap}
    .kpi{background:#0d1320; border:1px solid #1f2937; border-radius:12px; padding:10px 12px}
    [data-theme="light"] .kpi{ background:#ffffff; border-color:#e2e8f0 }
    .kpi b{font-size:20px}
    .footer{opacity:.7; font-size:12px; margin-top:12px}

    dialog{border:0; border-radius:16px; background:#0e1624; color:var(--text); padding:0; width:min(720px,96vw)}
    [data-theme="light"] dialog{ background:#ffffff; color:#0b0f14 }
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .modal-head{padding:14px 16px; border-bottom:1px solid #1f2a3a; display:flex; justify-content:space-between; align-items:center}
    [data-theme="light"] .modal-head{ border-bottom-color:#e2e8f0 }
    .modal-body{padding:14px 16px}
    .mini{font-size:12px; opacity:.8}

    /* === Block Tower === */
    .tower-wrap{margin-top:8px}
    .houses{display:flex; gap:8px; align-items:center; margin-bottom:8px}
    .house{font-size:24px}
    .tower-grid{display:grid; grid-template-columns:repeat(10, 14px); gap:3px; width:max-content; background:transparent; padding:4px; border-radius:8px}
    .cell{width:14px; height:14px; background:var(--acc); border-radius:3px; opacity:.9}
    .cell.empty{background:#223042; opacity:.5}
    [data-theme="light"] .cell.empty{background:#e2e8f0}

    /* === Quotes Banner === */
    .motto{display:flex; gap:8px; align-items:center; margin-top:2px; color:var(--muted)}
    .motto .dot{width:8px; height:8px; border-radius:999px; background:var(--acc); opacity:.8}
    .motto .text{transition:opacity .4s ease, transform .4s ease; will-change:opacity, transform}
    .motto.fade-out{opacity:0; transform:translateY(-6px)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px">
        <div>
          <h1 style="margin:0">30ë¶„ ë¸”ëŸ­ ë³´ìƒ ì„ íƒê¸°</h1>
          <div class="motto" aria-live="polite"><span class="dot"></span><span id="mottoText" class="text"></span></div>
        </div>
        <button class="btn" id="themeToggle" title="í…Œë§ˆ ì „í™˜">ğŸŒ“</button>
      </div>
      <div class="row" style="justify-content:space-between">
        <div class="timer" id="timer">30:00</div>
        <div class="row">
          <span class="pill" data-min="5">5ë¶„</span>
          <span class="pill" data-min="10">10ë¶„</span>
          <span class="pill" data-min="15">15ë¶„</span>
          <span class="pill" data-min="20">20ë¶„</span>
          <span class="pill active" data-min="30">30ë¶„</span>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="startBtn">ì‹œì‘</button>
        <button class="btn" id="pauseBtn">ì¼ì‹œì •ì§€</button>
        <button class="btn warn" id="resetBtn">ë¦¬ì…‹</button>
        <button class="btn" id="doneBtn">ì™„ë£Œ ì²˜ë¦¬</button>
        <button class="btn" id="wakeLockBtn" title="í™”ë©´ êº¼ì§ ë°©ì§€">í™”ë©´ìœ ì§€</button>
      </div>
      <div class="kpis" style="margin-top:14px">
        <div class="kpi">ì˜¤ëŠ˜ ë¸”ëŸ­ <b id="kToday">0</b></div>
        <div class="kpi">ì—°ì† ì¼ìˆ˜ <b id="kStreak">0</b></div>
        <div class="kpi">ëˆ„ì  ë¸”ëŸ­ <b id="kTotal">0</b></div>
      </div>

      <div class="tower-wrap">
        <h2>ë¸”ëŸ­ íƒ€ì›Œ</h2>
        <div class="houses" id="houses"></div>
        <div class="tower-grid" id="blockTower" aria-label="ëˆ„ì  ë¸”ëŸ­ ì‹œê°í™” (ìµœëŒ€ 100)"></div>
        <div class="mini muted" id="towerHint"></div>
      </div>

      <h2>ë³´ìƒ ë¹ ë¥¸ ì„ íƒ</h2>
      <div class="row" style="gap:8px; align-items:center; justify-content:space-between">
        <div class="row" style="gap:8px">
          <button class="btn" id="addReward">ë³´ìƒ ì¶”ê°€</button>
          <button class="btn" id="toggleEdit">ë³´ìƒ í¸ì§‘</button>
          <button class="btn ok" id="randomReward">ëœë¤ ë³´ìƒ</button>
        </div>
      </div>
      <div class="grid" id="rewardGrid"></div>
      <h2>ì„¤ì •</h2>
      <div class="row" style="gap:18px; align-items:center">
        <label><input type="checkbox" id="optSound" checked> ì•ŒëŒ ì†Œë¦¬</label>
        <label><input type="checkbox" id="optVibrate"> ì§„ë™</label>
        <label><input type="checkbox" id="optAutoModal" checked> ë³´ìƒì°½ ìë™ í‘œì‹œ</label>
        <button class="btn warn" id="clearAll">ì „ì²´ ê¸°ë¡ ì´ˆê¸°í™”</button>
      </div>
      <h2>íˆìŠ¤í† ë¦¬</h2>
      <div class="row" style="gap:8px; margin-bottom:6px">
        <button class="btn" id="undoLast">ë§ˆì§€ë§‰ í•­ëª© ì·¨ì†Œ</button>
      </div>
      <div class="log" id="history"></div>
      <div class="footer">ë¡œì»¬ ì €ì¥ì†Œë§Œ ì‚¬ìš©. ê³„ì •/ì„œë²„ ì—†ì´ ë¸Œë¼ìš°ì €ì—ì„œ ì¦‰ì‹œ ë™ì‘.</div>
    </div>
  </div>

  <!-- ì•ŒëŒ ì˜¤ë””ì˜¤ (ì†Œë¦¬ í•„ìš” ì—†ì–´ë„ í˜¸í™˜ ìœ ì§€) -->
  <audio id="alarmAudio" preload="auto" src="./alarm.mp3"></audio>

  <dialog id="rewardModal">
    <div class="modal-head">
      <div>ë¸”ëŸ­ ì™„ë£Œ! ë³´ìƒì„ ê³¨ë¼ì£¼ì„¸ìš”</div>
      <button class="btn" onclick="rewardModal.close()">ë‹«ê¸°</button>
    </div>
    <div class="modal-body">
      <div class="grid" id="modalRewards"></div>
      <div class="row" style="margin-top:12px; justify-content:space-between">
        <div class="mini muted">ë³´ìƒ í›„ 5ë¶„ íƒ€ì´ë¨¸</div>
        <button class="btn ok" id="startRewardTimer">ë³´ìƒ 5ë¶„ íƒ€ì´ë¨¸ ì‹œì‘</button>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="timer" id="rewardTimer">05:00</div>
        <button class="btn warn" id="stopRewardTimer">ë³´ìƒ íƒ€ì´ë¨¸ ì •ì§€</button>
      </div>
    </div>
  </dialog>

  <!-- ë³´ìƒ ì¶”ê°€ ëª¨ë‹¬ -->
  <dialog id="addRewardDlg">
    <div class="modal-head">
      <div>ë³´ìƒ ì¶”ê°€</div>
      <button class="btn" id="arClose">ë‹«ê¸°</button>
    </div>
    <div class="modal-body">
      <div class="field"><label class="mini muted">ë³´ìƒ ì´ë¦„</label><input id="arLabel" class="input" placeholder="ì˜ˆ: ë‹¤í¬ ì´ˆì½œë¦¿ í•œ ì¡°ê°" /></div>
      <div class="field"><label class="mini muted">íƒœê·¸(ì„ íƒ)</label><input id="arTag" class="input" placeholder="ì˜ˆ: ê°„ì‹" /></div>
      <div class="row" style="justify-content:flex-end; margin-top:8px">
        <button class="btn" id="arCancel">ì·¨ì†Œ</button>
        <button class="btn ok" id="arSave">ì¶”ê°€</button>
      </div>
    </div>
  </dialog>

  <!-- ì´ˆê¸°í™” í™•ì¸ ëª¨ë‹¬ -->
  <dialog id="confirmResetDlg">
    <div class="modal-head"><div>ì „ì²´ ê¸°ë¡ ì´ˆê¸°í™”</div></div>
    <div class="modal-body">
      <div class="mini" style="margin-bottom:10px">ëª¨ë“  ê¸°ë¡ê³¼ ì¹´ìš´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn" id="crNo">ì·¨ì†Œ</button>
        <button class="btn warn" id="crYes">ì´ˆê¸°í™”</button>
      </div>
    </div>
  </dialog>

  <script>
    const $=s=>document.querySelector(s);
    const $$=s=>Array.from(document.querySelectorAll(s));
    const timerEl=$('#timer');
    const rewardGrid=$('#rewardGrid');
    const historyEl=$('#history');
    const rewardModal=$('#rewardModal');
    const modalRewards=$('#modalRewards');
    const rewardTimerEl=$('#rewardTimer');

    const DEFAULT_REWARDS=[{label:'ì¢‹ì•„í•˜ëŠ” ìŒì•… 1ê³¡ ë“£ê¸°',tag:'ê°ê°'},{label:'ì¢‹ì•„í•˜ëŠ” ì˜ìƒí´ë¦½(5ë¶„ ì´í•˜) 1ê°œ',tag:'ê°ê°'},{label:'ì½”ë“œì»´ë±ƒ í•œ ë‹¨ê³„ í´ë¦¬ì–´',tag:'ì„±ì·¨'},{label:'ì•„ë‚´ì™€ ì§§ì€ ëŒ€í™”(5ë¶„)',tag:'ì •ì„œ'},{label:'ë‹¤í¬ ì´ˆì½œë¦¿ í•œ ì¡°ê°',tag:'ê°„ì‹'},{label:'VR íƒêµ¬ í•œíŒ',tag:'í™œë™'},{label:'ì½”ì¸ ê°€ê²© ë³´ê¸°(5ë¶„ ì œí•œ)',tag:'ê°€ë²¼ì›€'},{label:'ì°¨ í•œ ì”(í—ˆë¸Œí‹°/ë…¹ì°¨)',tag:'ê°ê°'},{label:'ì¸í„°ë„· ê²€ìƒ‰ 5ë¶„(ìŠ¤í¬ì¸ /ì»¤ë®¤ë‹ˆí‹°)',tag:'ê°€ë²¼ì›€'},{label:'ì„±ê²½ 1ì¥ ì½ê¸°',tag:'ì˜ë¯¸'},{label:'ìƒê° ë…¸íŠ¸ 1ì¤„ ì“°ê¸°',tag:'ì„±ì°°'}];
    let rewards=loadRewards();
    let editMode=false;

    let state=loadState();
    let settings=loadSettings();
    let duration=30*60; let remain=duration; let tHandle=null; let rHandle=null;
    let targetEnd=null; // deadline ê¸°ë°˜ íƒ€ì´ë¨¸ ëª©í‘œ ì‹œê°

    function renderTimer(){timerEl.textContent=fmt(remain);} 
    function fmt(sec){const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); return `${m}:${s}`;}

    function start(){
      if(tHandle) return;
      if(!targetEnd) targetEnd = Date.now() + remain * 1000;
      tHandle = setInterval(tick, 250);
    } 
    function pause(){
      if(tHandle){clearInterval(tHandle); tHandle=null;}
      if(targetEnd){
        remain = Math.max(0, Math.ceil((targetEnd - Date.now())/1000));
        targetEnd = null;
      }
      renderTimer();
    }
    function reset(){ pause(); remain=duration; targetEnd=null; renderTimer(); }
    function tick(){
      if(!targetEnd){ pause(); return; }
      remain = Math.max(0, Math.ceil((targetEnd - Date.now())/1000));
      renderTimer();
      if(remain===0){
        clearInterval(tHandle); tHandle=null; targetEnd=null;
        onBlockComplete('íƒ€ì´ë¨¸ ì™„ë£Œ');
      }
    }

    function onBlockComplete(reason){
      if(settings.sound) playAlarm(2);
      if(settings.vibrate&&'vibrate' in navigator) navigator.vibrate([120,60,120]);
      state.history.unshift({ts:new Date().toISOString(), note:`ë¸”ëŸ­ ì™„ë£Œ (${reason})`});
      recalcFromHistory(); saveState(); renderKPIs(); renderHistory(); renderBlockTower();
      if(settings.autoModal) rewardModal.showModal();
    }

    function renderKPIs(){
      $('#kToday').textContent=state.todayKey===todayKey()?state.todayCount:0;
      $('#kStreak').textContent=state.streak||0;
      $('#kTotal').textContent=state.totalBlocks||0;
    }

    function renderHistory(){
      if(!state.history.length){historyEl.innerHTML='<span class="muted">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</span>'; return;}
      historyEl.innerHTML=state.history.map((h,i)=>`<div>â€¢ ${escapeHtml(fmtLocal(h.ts))} â€” ${escapeHtml(h.note)} <button class="btn ghost mini" data-del="${i}">ì‚­ì œ</button></div>`).join('');
      $$('#history button[data-del]').forEach(btn=>{
        btn.onclick=()=>{const idx=parseInt(btn.dataset.del,10); state.history.splice(idx,1); recalcFromHistory(); saveState(); renderKPIs(); renderHistory(); renderBlockTower();};
      });
    }

    function renderRewards(){
      rewardGrid.innerHTML=''; modalRewards.innerHTML='';
      rewards.forEach((r,idx)=>{
        const chip=document.createElement('button');
        chip.type='button'; chip.className='reward';
        chip.innerHTML=`<div>${escapeHtml(r.label)}</div><div class="mini muted">#${escapeHtml(r.tag||'ë³´ìƒ')}</div>`;
        chip.onclick=()=>{if(editMode) return; selectReward(r.label);};
        rewardGrid.appendChild(chip);
        const chip2=chip.cloneNode(true); chip2.onclick=()=>selectReward(r.label); modalRewards.appendChild(chip2);
        if(editMode){
          const del=document.createElement('button'); del.type='button'; del.className='btn ghost mini'; del.textContent='ì‚­ì œ'; del.style.position='absolute'; del.style.top='6px'; del.style.right='6px';
          del.onclick=e=>{e.stopPropagation(); rewards.splice(idx,1); saveRewards(); renderRewards();};
          chip.style.position='relative'; chip.appendChild(del);
        }
      });
    }

    function selectReward(label){
      state.history.unshift({ts:new Date().toISOString(), note:`ë³´ìƒ ì„ íƒ: ${label}`});
      saveState(); renderHistory();
      rewardModal.close();
    }

    function startRewardTimer(){
      if(rHandle) return; let r=5*60; rewardTimerEl.textContent=fmt(r);
      rHandle=setInterval(()=>{r=Math.max(0,r-1); rewardTimerEl.textContent=fmt(r); if(r===0){clearInterval(rHandle); rHandle=null; if(settings.sound) playAlarm(1); if(settings.vibrate&&'vibrate' in navigator) navigator.vibrate(120);}},1000);
    } 
    function stopRewardTimer(){ if(rHandle){clearInterval(rHandle); rHandle=null;} rewardTimerEl.textContent='05:00'; }

    // ====== ë³´ìƒ ì¶”ê°€ ëª¨ë‹¬ ======
    const addDlg=$('#addRewardDlg');
    $('#addReward').onclick=()=>{ $('#arLabel').value=''; $('#arTag').value=''; addDlg.showModal(); setTimeout(()=>$('#arLabel').focus(),0); };
    $('#arClose').onclick=()=>addDlg.close();
    $('#arCancel').onclick=()=>addDlg.close();
    $('#arSave').onclick=()=>{ const label=$('#arLabel').value.trim(); if(!label){ $('#arLabel').focus(); return; } const tag=$('#arTag').value.trim(); rewards.push({label, tag}); saveRewards(); renderRewards(); addDlg.close(); };
    $('#arLabel').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); $('#arSave').click(); }});
    $('#arTag').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); $('#arSave').click(); }});

    // ====== ì´ˆê¸°í™” í™•ì¸ ëª¨ë‹¬ ======
    const resetDlg=$('#confirmResetDlg');
    $('#clearAll').onclick=()=> resetDlg.showModal();
    $('#crNo').onclick=()=> resetDlg.close();
    $('#crYes').onclick=()=>{ state=initialState(); saveState(); renderKPIs(); renderHistory(); renderBlockTower(); resetDlg.close(); };

    function todayKey(){return new Date().toISOString().slice(0,10);} 
    function initialState(){ return {todayKey:todayKey(),todayCount:0,streak:0,totalBlocks:0,lastDay:null,history:[]}; }

    function loadState(){try{return JSON.parse(localStorage.getItem('block-reward-lite'))||initialState();}catch(e){return initialState();}}
    function saveState(){localStorage.setItem('block-reward-lite',JSON.stringify(state));}
    function loadSettings(){try{return Object.assign({sound:true,vibrate:false,autoModal:true},JSON.parse(localStorage.getItem('block-reward-lite-settings')||'{}'));}catch(e){return{sound:true,vibrate:false,autoModal:true};}}
    function saveSettings(){localStorage.setItem('block-reward-lite-settings',JSON.stringify(settings));}
    function loadRewards(){try{const v=JSON.parse(localStorage.getItem('block-reward-lite-rewards')); return Array.isArray(v)&&v.length? v: DEFAULT_REWARDS.slice();}catch(e){return DEFAULT_REWARDS.slice();}}
    function saveRewards(){localStorage.setItem('block-reward-lite-rewards',JSON.stringify(rewards));}

    function recalcFromHistory(){
      const dates=new Set(); let todayCount=0; const today=todayKey(); let total=0; let latest=null;
      state.history.forEach(h=>{
        if(!/^ë¸”ëŸ­ ì™„ë£Œ \(/.test(h.note)) return; // ë³´ìƒ ì„ íƒ ë¡œê·¸ëŠ” ì œì™¸
        total++;
        const d=(h.ts||'').slice(0,10);
        if(d){ dates.add(d); if(d===today) todayCount++; if(!latest||d>latest) latest=d; }
      });
      state.totalBlocks=total; state.todayKey=today; state.todayCount=todayCount; state.lastDay=latest; state.streak=computeStreak(dates, latest);
    }

    function computeStreak(dates, latest){if(!latest) return 0; let s=0; let cur=new Date(latest); while(true){const k=cur.toISOString().slice(0,10); if(dates.has(k)){s++; cur.setDate(cur.getDate()-1);} else break; } return s;}
    function fmtLocal(iso){try{return new Date(iso).toLocaleString();}catch(e){return iso;}}
    function escapeHtml(s){return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));}

    // ì²´í¬ë°•ìŠ¤ ì´ˆê¸°ê°’ ë° í•¸ë“¤ëŸ¬
    $('#optSound').checked=settings.sound; $('#optVibrate').checked=settings.vibrate; $('#optAutoModal').checked=settings.autoModal;
    $('#optSound').onchange=()=>{settings.sound=$('#optSound').checked; saveSettings();};
    $('#optVibrate').onchange=()=>{settings.vibrate=$('#optVibrate').checked; saveSettings();};
    $('#optAutoModal').onchange=()=>{settings.autoModal=$('#optAutoModal').checked; saveSettings();};

    // í…Œë§ˆ í† ê¸€
    (function(){const root=document.documentElement; const key='block-reward-lite-theme'; const saved=localStorage.getItem(key); if(saved==='light'||saved==='dark') root.setAttribute('data-theme', saved); $('#themeToggle').addEventListener('click', ()=>{unlockAudio(); const cur=root.getAttribute('data-theme'); const next=cur==='light'?'dark':cur==='dark'?null:'light'; if(next){root.setAttribute('data-theme', next); localStorage.setItem(key,next);} else {root.removeAttribute('data-theme'); localStorage.removeItem(key);} });})();

    // ì˜¤ë””ì˜¤ ì–¸ë½ & ì•ŒëŒ ì¬ìƒ (iOS ëŒ€ì‘)
    let audioCtx=null; let audioUnlocked=false;
    function unlockAudio(){
      if(audioUnlocked) return; audioUnlocked=true;
      try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); audioCtx.resume(); }catch(e){}
      const a=$('#alarmAudio'); if(a){ a.volume=0.01; const p=a.play(); if(p&&p.then){ p.then(()=>{ a.pause(); a.currentTime=0; a.volume=1; }).catch(()=>{}); } }
    }
    function playAlarm(times=1){
      const a=$('#alarmAudio');
      if(a && a.src){
        let count=0; const once=()=>{ try{ a.currentTime=0; a.play().catch(()=>{});}catch(_){}; };
        once(); if(times>1){ const id=setInterval(()=>{ once(); if(++count>=times-1) clearInterval(id); },600); }
        return;
      }
      try{
        if(!audioCtx) return; let t=audioCtx.currentTime; for(let i=0;i<times;i++){ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.value=i%2?660:880; o.connect(g); g.connect(audioCtx.destination); g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.25,t+0.02); o.start(t); o.stop(t+0.22); t+=0.32; }
      }catch(e){}
    }

    // === Block Tower ë Œë” ===
    function renderBlockTower(){
      const tower=$('#blockTower'); const housesEl=$('#houses'); const hint=$('#towerHint');
      const blocks=state.totalBlocks||0; const houses=Math.floor(blocks/100); const rem=blocks%100;

      housesEl.innerHTML = houses? Array.from({length:houses}).map(()=>'<span class="house" title="100 ë¸”ëŸ­ ë‹¬ì„±!">ğŸ </span>').join('') : '<span class="mini muted">ì•„ì§ ì§‘ì´ ì—†ìŠµë‹ˆë‹¤ (100ë¸”ëŸ­ë§ˆë‹¤ ğŸ )</span>';

      let cells='';
      for(let i=0;i<100;i++){
        const filled = i < rem;
        cells += `<div class="cell${filled?'':' empty'}"></div>`;
      }
      tower.innerHTML=cells;
      hint.textContent = `ëˆ„ì  ${blocks} ë¸”ëŸ­ Â· ì§‘ ${houses}ê°œ Â· ë‹¤ìŒ ì§‘ê¹Œì§€ ${100-rem} ë¸”ëŸ­`;
    }

    // === Quotes (5ì´ˆ ìˆœí™˜) ===
    const QUOTES = [
      'ëŠ¦ê²Œë‚˜ë§ˆ ë°°ìš°ëŠ” ê²ƒì´ ë°°ìš°ì§€ ì•ŠëŠ” ê²ƒ ë³´ë‹¤ ë‚«ë‹¤.',
      'ì‚°ì„ ì˜®ê¸°ëŠ” ì‚¬ëŒì€ ì‘ì€ ëŒë©©ì´ë¶€í„° ì˜®ê¸´ë‹¤.',
      'ì²œë¦¬ê¸¸ë„ í•œ ê±¸ìŒë¶€í„°',
      'ê±·ì§€ë„ ëª»í•˜ë©´ì„œ ë›°ë ¤ê³  í•œë‹¤.',
      'ê°€ì¥ ë†’ì€ ê³³ì— ì˜¤ë¥´ë ¤ê±°ë“ , ê°€ì¥ ë‚®ì€ ê³³ì—ì„œ ì‹œì‘í•˜ë¼.',
      'ì‘ì€ ë¬¼ë°©ìš¸ì´ ëª¨ì´ë©´ ë°”ìœ„ë¥¼ ëš«ëŠ”ë‹¤.',
      'ë‹¨ 10ë¶„ì´ë¼ë„ ì˜ë¯¸ê°€ ìˆë‹¤.',
      'í•˜ë£¨ 1ì‹œê°„ì´ë¼ë„ ì¼ì£¼ì¼ì´ë©´ 7ì‹œê°„, 1ë…„ì´ë©´ 365ì‹œê°„, 10ë…„ì´ë©´ 3650ì‹œê°„ì´ë‹¤.',
      'ë‚˜ëŠ” ë‚´ ì‚¬ì •ê³¼ ì‹¸ìš°ê³  ìˆê³ , ë‚˜ëŠ” ë‚¨ë“¤ê³¼ ë‹¤ë¥¸ ì‚°ì„ ì˜¤ë¥´ê³  ìˆë‹¤.',
      'ë‚˜ëŠ” ë‚´ ì†ë„ë¡œ, ë‚´ ë°©í–¥ìœ¼ë¡œ, ì˜¤ëŠ˜ ë©ˆì¶”ì§€ ì•Šê³  ê±·ê³  ìˆë‹¤.'
    ];
    (function rotateQuotes(){
      const el = document.getElementById('mottoText');
      if(!el) return;
      let idx = parseInt(localStorage.getItem('br-quote-index')||'0',10) || 0;
      const show = ()=>{
        const wrap = el.closest('.motto');
        if(wrap) wrap.classList.add('fade-out');
        setTimeout(()=>{
          el.textContent = QUOTES[idx % QUOTES.length];
          idx = (idx+1) % QUOTES.length;
          localStorage.setItem('br-quote-index', String(idx));
          if(wrap) wrap.classList.remove('fade-out');
        }, 380);
      };
      show();
      setInterval(show, 5000);
    })();

    // === Wake Lock (í™”ë©´ìœ ì§€) ===
    let wakeLock = null;
    async function requestWakeLock(){
      try{
        if('wakeLock' in navigator && !wakeLock){
          wakeLock = await navigator.wakeLock.request('screen');
          $('#wakeLockBtn').textContent = 'í™”ë©´ìœ ì§€ ON';
          wakeLock.addEventListener('release', ()=>{ $('#wakeLockBtn').textContent='í™”ë©´ìœ ì§€'; wakeLock=null; });
        } else if(!('wakeLock' in navigator)){
          alert('ì´ ë¸Œë¼ìš°ì €ëŠ” í™”ë©´ìœ ì§€ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
      }catch(e){
        console.warn('WakeLock ì‹¤íŒ¨', e);
        alert('í™”ë©´ìœ ì§€ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
    }
    function releaseWakeLock(){ try{ if(wakeLock){ wakeLock.release(); wakeLock=null; $('#wakeLockBtn').textContent='í™”ë©´ìœ ì§€'; } }catch(_){} }
    $('#wakeLockBtn').onclick=()=>{ if(wakeLock) releaseWakeLock(); else requestWakeLock(); };

    // íƒ­ ì¬ì§„ì… ì‹œ íƒ€ì´ë¨¸/ì›¨ì´í¬ë½ ë³´ì •
    document.addEventListener('visibilitychange', ()=>{
      if(document.hidden) return;
      if(targetEnd){
        remain = Math.max(0, Math.ceil((targetEnd - Date.now())/1000));
        renderTimer();
        if(remain === 0){
          if(tHandle){ clearInterval(tHandle); tHandle = null; }
          targetEnd = null;
          onBlockComplete('ë°±ê·¸ë¼ìš´ë“œ ê²½ê³¼ë¡œ ìë™ ì™„ë£Œ');
        }
      }
      if(wakeLock){ requestWakeLock().catch(()=>{}); }
    });
    window.addEventListener('pageshow', ()=>{
      if(targetEnd){ remain = Math.max(0, Math.ceil((targetEnd - Date.now())/1000)); renderTimer(); }
    });

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    const bindAndUnlock=(el,handler)=>{ el.onclick=(e)=>{ unlockAudio(); handler(e); }; };
    bindAndUnlock($('#startBtn'), start); bindAndUnlock($('#pauseBtn'), pause); bindAndUnlock($('#resetBtn'), reset); bindAndUnlock($('#doneBtn'), ()=>{ pause(); onBlockComplete('ìˆ˜ë™ ì™„ë£Œ'); });
    $('#startRewardTimer').onclick=()=>{ unlockAudio(); startRewardTimer(); }; $('#stopRewardTimer').onclick=()=>{ unlockAudio(); stopRewardTimer(); };

    // ë¶„ ì„ íƒ
    $$('.pill').forEach(p=>{ p.onclick=()=>{ unlockAudio(); $$('.pill').forEach(x=>x.classList.remove('active')); p.classList.add('active'); const newDur=parseInt(p.dataset.min,10)*60; if(tHandle && targetEnd){ const nowRemain=Math.max(0, Math.ceil((targetEnd - Date.now())/1000)); duration=newDur; targetEnd=Date.now()+duration*1000; remain=duration; renderTimer(); } else { duration=newDur; remain=duration; targetEnd=null; renderTimer(); } }; });

    $('#toggleEdit').onclick=()=>{ unlockAudio(); editMode=!editMode; renderRewards(); };
    $('#randomReward').onclick=()=>{ unlockAudio(); if(!rewards.length) return; const pick=rewards[Math.floor(Math.random()*rewards.length)]; selectReward(pick.label); };
    $('#undoLast').onclick=()=>{ unlockAudio(); if(state.history.length){ state.history.shift(); recalcFromHistory(); saveState(); renderKPIs(); renderHistory(); renderBlockTower(); } };
    window.addEventListener('touchstart', unlockAudio, {once:true, passive:true});

    // ì´ˆê¸° ë Œë”
    renderTimer(); renderKPIs(); renderRewards(); renderHistory(); renderBlockTower();
  </script>
</body>
</html>
